	<!DOCTYPE html>
	<html lang="en">
	  <head>
	  {% load staticfiles %}
	  <link href="{% static "WONKA/bootstrap.css" %}" media="screen" rel="stylesheet"/>
	  <script src="{% static "OOMMPPAA/jquery-1.7.min.js" %}"></script>
	  <script src="{% static "WONKA/bootstrap.min.js" %}"></script>
	  <script src="{% static "WONKA/filesaver.js" %}"></script>
	  <script src="{% static "OOMMPPAA/spin.js" %}"></script>
	  <script src="{% static "WONKA/base_64.min.js" %}"></script>
	  <script src="{% static "WONKA/ICM_funs.js" %}"></script>
	  <script src="{% static "WONKA/nprogress.js" %}"></script>
	<link rel='stylesheet' href='{% static "WONKA/nprogress.css" %}'/> 
	  <script src="{% static "OOMMPPAA/isotope.min.js" %}"></script>
	  <link rel="shortcut icon" href="{% static "WONKA/icon.ico" %}" type="image/x-icon">
	  <script src="{% static "OOMMPPAA/bootstrap-slider.js" %}"></script>
	  <link rel="stylesheet" href="{% static "OOMMPPAA/bootstrap.min.css" %}">
	
	  <link rel="stylesheet" href="{% static "OOMMPPAA/slider.css" %}">
	   <title>WONKA: {{ target.title }}</title>
	   <meta name="viewport" content="width=device-width, initial-scale=1.0">
	   <meta charset="utf-8">
	   <script>
	
function loadsite(target_id,site_id){
my_url = "{% url 'WONKA:Summarise' 0 %}?my_site="+site_id
my_url = my_url.replace("/0/","/"+target_id+"/")
alert("THIS WILL OPEN A NEW TAB -> WITH ANALYSIS OF THE SELECTED SITE. PLEASE BE PATIENT WHILE IT LOADS");
var win = window.open(my_url, '_blank');
win.focus();


}	   
	   function on_load_fun(){
	{% if html_text %}
	            undisplay_all('MOL');
	              			act = new Module.ActiveIcm("act_div",800,600);
	            //var ctl =document.getElementById('ActiveIcmCtl');
	 	act.OpenProject("{{my_src }}",{
	
	     	 onload: function () {           
					 act.RunCommands("display a_*key_water.* xstick  red");
					 act.RunCommands("display a_*key_site.* xstick");
					 act.RunCommands("display a_*key_site.* cpk");
					 act.RunCommands("display a_*RESME*.* xstick");
					 act.RunCommands("display a_*water.* &! a_*key_water.* xstick  blue");
					  //ctl.RunCommands("undisplay a_*water.* cpk");
					  //ctl.RunCommands("display a_url*. xstick");
					  //ctl.RunCommands("undisplay a_url*. cpk");
					 act.RunCommands("display a_*mol*. xstick");
					 act.RunCommands("display a_*prot*. ribbon");
					 act.RunCommands("display Res(Sphere(a_*mol*. a_*prot*. 5.0) & a_*prot*.) xstick");
					  //ctl.RunCommands("display a_*key_*. cpk");
					  //ctl.RunCommands("display a_*ph4. cpk");
					  }
	});
	
	var OSName="Unknown OS";
	if (navigator.appVersion.indexOf("Win")!=-1) OSName="Windows";
	if (navigator.appVersion.indexOf("Mac")!=-1) OSName="MacOS";
	if (navigator.appVersion.indexOf("X11")!=-1) OSName="UNIX";
	if (navigator.appVersion.indexOf("Linux")!=-1) OSName="Linux";
	  act.RunCommands("center a_*RESME*.")            
	  act.RunCommands("center a_*key*.")
	  act.RunCommands("center a_*mol*.")
	act.RunCommands("display grob")
	act.RunCommands('color background rgb={255,255,255}')
	
	{% else %}
	
	{%endif%}
	
	}
	
	
	</script>
	<script>

	Module = {
	  memoryInitializerPrefixURL:'{% static "WONKA/lib/" %}',
	  preInit: function() { /*alert('preinit');*/ }
	}
	</script>
	<script src="{% static "WONKA/lib/libicm.js" %}"> </script>
	   
	  </head>
	  <body>
	  
	  {% if html_text %}
	  {{  html_text | safe }}
	  {% else %}
	  <style>
	  .item {}
	  
	  .modal-dialog{
	position: absolute;
	left: 50%;
	//now you must set a margin left under zero - value is a half width your window
	margin-left: -312px;
	// this same situation is with height - example
	height: 800px;
	top: 10%;
	
	} 
	
	.carousel-control {
	  padding-top:10%;
	  width:5%;
	}
	
	.protClass
	{
	border-style:dashed;
	border-color:grey;
	}
	
	.waterClass
	{
	outline: 2px blue dashed;
	}
	
	.ph4Class
	{
	box-shadow: 0 0 0 3px hsl(0, 0%, 80%);
	}
	
	
	.coveringCanvas{ 
	    z-index:100000000000000;
	    background-color: rgba(0,0,0,.1);
	}
	.img_class{
	
	}
	.container{
	    display:inline-block;
	    width:49%; 
	    margin: 0 auto; 
	    position:relative;
	    }
	    
	.btn-on{
	
		border-color: #FD0000;
	
	
	}
	.btn-off{
	
		border-color: #484857;
	
	}
	
	</style>
	
	
	<script>




	
	var ph4_opt = "Standard";
	var loadmymolold = "";
	var target_id = {{ target.pk }};
	var target_name= '{{ target.title }}';
	
			     function onLoadActiveIcm(){
	  			act = new Module.ActiveIcm("act_div",0,0);
	//  act.projectFile = "http://163.1.63.28:9010/Viewer/loader/?choice=1FYR_a_6&function=VIEWPROTEIN";  // by PDB code
	  // size 0,0 means inherit the parent size
	  	  act.OpenProject("{% static "OOMMPPAA/shapes.icb" %}",{
	     onload: function () {
	     			act.RunCommands("undisplay grob");
	    }
	     })
	
				click_prot("",'{{tot_mols.0.pk}}','{{ tot_mols.0.code}}');
				$('#MOL{{tot_mols.0.pk}}').click();
	    var mol_string = mybase+'/Viewer/loader/?choice={{tot_mols.0.pk}}&function=VIEWMOLPK';
		act.OpenProject(mol_string,{
	    	 name:   '{{tot_mols.0.pk}}mol',
	     	 onload: function () {
				act.RunCommands('display a_{{tot_mols.0.pk}}mol*.* xstick');
				act.RunCommands('color a_{{tot_mols.0.pk}}mol*./*/c* lightyellow');	
				 act.RunCommands("center a_{{tot_mols.0.pk}}mol.");
				 act.RunCommands('display Res(Sphere(a_*.m  a_*prot*.* 5)) xstick');

				(function my_func() {
				    if (act.nofActiveDownloads == 0) {
								act.RunCommands('display a_{{tot_mols.0.pk}}mol*.* xstick');
								act.RunCommands('color a_{{tot_mols.0.pk}}mol*./*/c* lightyellow');	
								act.RunCommands("center a_{{tot_mols.0.pk}}mol.");
								act.RunCommands('display Res(Sphere(a_*.m  a_*prot*.* 5)) xstick');
				    }
				    else{
				    setTimeout( my_func, 1000 );
				    }
				})();
				 
				 
	    }
	
	     })	
	
		        // Load the protein
	
				var prot_string = mybase+'/Viewer/loader/?choice={{ tot_mols.0.code}}&function=VIEWPROTEIN';     
	  			act.OpenProject(prot_string,{
	  			name:   '{{ tot_mols.0.code}}prot',
	            onload: function () {
	     		    $('#key-water-button').click();
	     		    act.RunCommands('display Res(Sphere(a_*.m  a_*prot*.* 5)) xstick');
	
	    }
	
	     })
	     
		    //    setTimeout(function(){     
	     
	    
	 //     },1000)
	      
	      }		
	
	
	
	    
	window.onload = function()
	                {
	 
	                
	    $container.isotope({sortBy : 'category'});
	};
	 $(function(){
	    $("[data-hide]").on("click", function(){
	        $("." + $(this).attr("data-hide")).hide();
	        // -or-, see below
	        // $(this).closest("." + $(this).attr("data-hide")).hide();
	    });
	});
	var orig_body = "";
	$(function () { $("[data-toggle='tooltip']").tooltip(); }); 
	var spinner = '{% static "OOMMPPAA/spinner.gif" %}'
	    	$(document).ready(function() {
	            $('.btn').button()
	            var spinurl = mybase+spinner;
	 
	            var img = document.createElement("IMG");
	      		    set_data_dp();
	            img.src = spinurl;     		
		    	/* Make sliders */
		        $("#confs").slider({});
		        $("#conserved").slider({});
		        $("#pharma").slider({});
		        $("#redgraph").slider({});
		        $container = $('#iso-cont').isotope({
		        getSortData: { category: '[data-category]',
		        
		        //cluster: function( itemElem ) {
			    //  var weight = $( itemElem ).children()[0].dataset["cluster"];
			     // return parseInt( weight.replace( /[\(\)]/g, '') );
	    	//		},
		     //   activity: function( itemElem ) {
			   //   var weight = $( itemElem ).children()[0].dataset["activity"];
			   //   return parseFloat( weight.replace( /[\(\)]/g, '') );
	    //			},
	    			
	//		    selected : function( itemElem ){
				        // sort by selected first, then by original order
	//			        return ($( itemElem ).children()[0].style["opacity"] == "1" ? 10 : 0 );
	//			      }
		        
		        	}
		        
		        })
		        setTimeout(function(){
		        console.log("main");
	
	
	            var body = document.getElementsByTagName("body");
				var bodycontent = body[0];
				orig_body = bodycontent.innerHTML;
		        },2000)
	    	});
	    	
	$(document).keypress(function(event) {
		
	    var keycode = (event.keyCode ? event.keyCode : event.which);
	    if (keycode == '13') {
	        event.preventDefault();
	        $('#searchbutt').click();
	    }
	});
	
	
	
	function show_res(res_name,div_name,my_colour){
	
	   if ($('#'+div_name).is(':checked')){
	   
	   act.RunCommands('display a_./'+res_name+' &! a_RESME*. cpk ');
	   act.RunCommands('display a_./'+res_name+' &! a_RESME*. xstick ');
	   act.RunCommands('color a_.//c* & a_./'+res_name+' &! a_RESME*. '+my_colour);
	   act.RunCommands('color a_.//c* & a_./'+res_name+' &! a_RESME*. '+my_colour);
	   $('#'+div_name).parent()[0].style["opacity"] = 0.4;
	   }
	   
	   else{
	   //act.RunCommands('color a_.//c* & a_./'+res_name+' white');
	   //act.RunCommands('display a_./'+res_name+' xstick');
	   act.RunCommands('undisplay a_./'+res_name+' cpk');
	   act.RunCommands('undisplay a_./'+res_name+' xstick');
	   $('#'+div_name).parent()[0].style["opacity"] = 1.0;
	   }
	
	
	};
	
	function alert_prop(res_me_name_dp){
	    	var colour = res_me_name_dp.split("____")[1]
	    	var res_me_name = res_me_name_dp.split("____")[0]
			var icm_s = 'display a_'+res_me_name +' xstick';
			console.log(res_me_name_dp);
			act.RunCommands(icm_s);
			var icm_s = 'display a_'+res_me_name+'*. xstick';
			act.RunCommands(icm_s);
			var icm_s = 'display a_'+res_me_name+'*. & a_.//c* '+ colour + ' xstick';
			act.RunCommands(icm_s);
			
	}
	
	function centre_res(res_name){
	
	// Loop through a dict -> res_name: model name (to load the protein) : protein colour 
	var my_prots = out_res_d[res_name]
	
	
	for(var propt in my_prots){
	
		//var prot_string = 
	    //var res_me_name_in = 'RESME_'+res_name.slice(1)+'_'+propt+'*.____'+my_prots[propt]
	   
	   var url_s = mybase+'/Viewer/loader/?choice='+propt+'&function=VIEWALLRES&option=' + res_name.slice(1)
	   var name = 'RESME_'+res_name.slice(1)+'_'+propt
	   var data = 'RESME_'+res_name.slice(1)+'_'+propt+'____'+my_prots[propt]
	   // First bring the protein in
	   act.OpenProject(url_s,
	    {
	        name: name,
	        data: data,
	        onload: function (res_me_name_in_arg) { alert_prop(res_me_name_in_arg); }   // res_me_name_in_arg will be substituted each time with value  from 'data' field.    
	     })
	}
	
	};
	
	
	
	function del_res(res_name){
	
	// Loop through a dict -> res_name: model name (to load the protein) : protein colour 
	var my_prots = out_res_d[res_name]
	// First bring the protein in
	
	for(var propt in my_prots){
	
	icm_s = 'delete a_RESME_'+res_name.slice(1)+'_'+propt+'*.*'
	act.RunCommands(icm_s);
	
	}
	
	
	
	};
	
var my_txt = 'Rotate:\tleft-click and drag.\nZoom in:\tleft-click and drag on the left-hand side of the 3D Molecule display.\nCrop:\tleft-click and drag on on the right-hand side of the 3D Molecule display.\nRecentre:\tClick button at the centre bottom of the 3D Molecule display'
	
	function re_select_data(){
		act.RunCommands('delete my_var');
	//	act.RunCommands('my_var = ');
		var my_var = act.RunCommandsValue('String(Box())').replace(/ /g,'');
		url_string = mybase+'/WONKA/{{  target.pk  }}/Summarise/?map='+my_var;
		window.open(url_string, '_blank');
	}
	function show_mol_prot(url,div_name,my_colour,my_size, my_opt){
		var my_pk = document.getElementById(div_name).value;
	
	if ($('#'+div_name).is(':checked')){
		var my_s = 'read pdb "'+url+'" name="'+div_name+'"';
		// Load the points
		//act.RunCommands(my_s);
	
		// For the waters	
		if(my_size!=undefined & my_opt=="water"){
	
	act.OpenProject(url,{
	     name:   div_name,
	     onload: function () {
		act.RunCommands('display a_'+div_name+'. xstick');
		act.RunCommands('color a_'+div_name+'. red');
		act.RunCommands('set atom ball a_'+div_name+'. '+ my_size.toString());
		water_pks.push(my_pk)
	     }
	   });
	
	
	
		}
		else if(my_size!=undefined & my_opt=="ph4"){
	act.OpenProject(url,{
	     name:   div_name,
	     onload: function () {
	
		
		act.RunCommands('new_shape = star');
		act.RunCommands('vals = Xyz(new_shape)');
		act.RunCommands('new_vals = vals*5*'+my_size);
		act.RunCommands('set new_shape new_vals');
		act.RunCommands('my_trans = -Mean(Xyz(new_shape))');
		act.RunCommands('display a_'+div_name+'. wire');
		act.RunCommands('translate new_shape my_trans');
		act.RunCommands('translate new_shape Xyz(a_'+div_name+'.)');
		act.RunCommands('display new_shape');
		act.RunCommands('color new_shape ' + my_colour);
		act.RunCommands('rename new_shape '+div_name);
		seleph4_pks.push(my_pk)
	     }
	   });
		}
		else{
	act.OpenProject(url,{
	     name:   div_name,
	     onload: function () {
		act.RunCommands('display a_'+div_name+'. cpk');
		act.RunCommands('display a_'+div_name+'. xstick');
		act.RunCommands('color a_'+div_name+'. '+my_colour);
		}
		});
	}	
		$('#'+div_name).parent()[0].style["opacity"] = 0.4;
	
	
	}
	else{
	
		if(my_size!=undefined & my_opt=="ph4"){
		act.RunCommands('delete ' + div_name);
		act.RunCommands('delete a_'+div_name+'. ');
			var index = seleph4_pks.indexOf(my_pk);
			if (index > -1) {
			    seleph4_pks.splice(index, 1);
			}
		}
	
		else if(my_size!=undefined & my_opt=="water"){
			var index = water_pks.indexOf(my_pk);
			if (index > -1) {
			    water_pks.splice(index, 1);
			}
	       act.RunCommands('delete a_'+div_name+'*. ');
	     }
	     else {
	     act.RunCommands('delete a_'+div_name+'*. ');
	     }
	     $('#'+div_name).parent()[0].style["opacity"] = 1.0;
	             
	             
	             
	};
	
	}
	
	
	function show_mol_frags(pdb_code){
	var url_string =mybase+'/WONKA/ScoreMol/?target={{  target.pk }}&code='+pdb_code+'&opt=frag'
	$.ajax({
	  url: url_string,
	  beforeSend: function( xhr ) {
	    xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
	  }
	}).done(function(data){
	  
	    response = $.parseJSON(data);
	  
	  
	  $(function() {
	   var HTML_out = "";
	    $.each(response, function(i, item) {
	        var my_score = item.score.toFixed(2);
	
	            
	            HTML_out += '<img src="/Viewer/loader/?function=2DMOL&choice='+item.type+'" style="width:40%"></img>'
	
	
	        
	    });
	    
	    
	    $('#ph4-container').innerHTML = HTML_out;
	  
	 
	  
	  })
	})
	};
	
	
	
	
	function fill_in(mol_pk,my_colour,counter){
	
	}
	
	function clear_canv(mol_pk){
	
	}
	
	
	function draw_text(mol_pk,text,i){
	var my_canvas = "MOL"+mol_pk+"CAN";
	var c = document.getElementById(my_canvas);
	var ctx = c.getContext("2d");
	ctx.font="20px Georgia";
	var start_pos = 50+(i*10)
	ctx.fillText(text,start_pos,0);
	}
	
	
	function show_one(div_name, class_name, show_class, json_key){
	var my_class = '.'+class_name;
	var my_div = '#'+div_name+"-div"
	
	var class_div = $(my_class);
	var all_but_one = $(my_class).not(my_div);
	
	$(my_class).show();
	
	$(my_class).not(my_div).hide();
	
	$(".top-show").each(function(){
	
	// Uncheck everything
	//if ($(this).is(':checked')){
	//    $(this).click();
	//    $(this).click().attr('checked', false);
	//    }
	
	
	});
	
	
	
	// Check what we want to check
	$("."+show_class).each(function(){
	    $(this).click();
	    $(this).click().attr('checked', true);
	});
	
	// First blank the canvas for all of them
	var my_mols = tot_data["all_mols"];
	for (var mol in my_mols){
	   clear_canv(my_mols[mol])
	
	};
	// Now get the ones we want to colour
	var my_json = tot_data[json_key];
	var counter = -1;
	for (var key in my_json) {
	    counter +=1;
	    if (my_json.hasOwnProperty(key)) { // check if the key exists
	    var my_l = key.split("_")
	    my_colour =my_l[0]
	    my_counter = my_l[1]
	    for(var num in my_json[key]){
	        //fill_in( my_json[key][num], my_colour, my_counter); // now colour all these with this colour
	        }
	    }
	}
	
	
	};
	
	
	function highlight_mols(highlight_feat, pos_neg, highlight_colour){
	// First make an ajax call to get the list of appropriate molecule pks
	var mol_string = mybase+'/WONKA/loader/?choice='+code+'&function=VIEWMOL';
	}
	
	
	// Global variable to store pks
	var mol_pks = [];
	var prot_pks = [];
	var water_pks = [];
	var seleph4_pks = [];
	function undisplay_all(arg){
	var tmp_pks = [];
	
	if(arg=="MOL"){
	my_pks = mol_pks;
	}
	
	if(arg=="PROT"){
	my_pks = prot_pks;
	}
	
	
	
	while (mol_pks.length > 0) {
	    var my_s = "#MOL"+my_pks[0].toString()
	    //Do something
	    $(my_s).click();
	}
	
	
	}
	
	
	function click_mol(my_pk, code){
	
	
	
	var my_div = "MOL"+my_pk;
	var my_mol_div = "MOL"+my_pk+"BL";
	if (document.getElementById(my_div).style.opacity == 1.0){
	
	
	
	var index = mol_pks.indexOf(my_pk);
	if (index > -1) {
	    mol_pks.splice(index, 1);
	}
	
	//
	$("."+my_div).removeClass("btn-on").addClass( "btn-off" );
	
	
	document.getElementById(my_div).style.opacity = 0.5;
	act.RunCommands('delete a_'+my_pk+'mol*.*');
	}
	else{
	
	$("."+my_div).removeClass("btn-off").addClass( "btn-on" );
	mol_pks.push(my_pk)
	
	document.getElementById(my_div).style.opacity = 1.0;
	
	// Now -> change the order of rows
	document.getElementById(my_mol_div)
	
	// Now load the molecule
	var mol_string = mybase+'/Viewer/loader/?choice='+my_pk+'&function=VIEWMOLPK';
	//act.OpenProject(mol_string)
	act.OpenProject(mol_string,{
	     name:   my_pk+'mol',
	     onload: function () {
	act.RunCommands('display a_'+my_pk+'mol*.* xstick');
	act.RunCommands('color a_'+my_pk+'mol*./*/c* lightyellow');
	     }
	   });
	
	}
	}
	
	
	function click_prot(event, my_pk, code, opt){
	
	
	var my_div = "MOL"+my_pk
	// If it is on
	if (document.getElementById(my_div+"BL").className.indexOf(opt+"Class") > -1){
	
	var re = new RegExp(opt+"Class", "g");
	document.getElementById(my_div+"BL").className = document.getElementById(my_div+"BL").className.replace(re,'')
	
	var index = prot_pks.indexOf(my_pk);
	if (index > -1) {
	    prot_pks.splice(index, 1);
	}
	
	
	act.RunCommands('delete a_'+code+'prot*.*');
	}
	else{
	document.getElementById(my_div+"BL").className += " protClass";
	//fill_in(my_pk,"black","6");
	var prot_string = mybase+'/Viewer/loader/?choice='+code+'&function=VIEWPROTEIN';
	act.OpenProject(prot_string,{
	     name:   code+'prot',
	     onload: function () {
	act.RunCommands('display a_'+code+'prot*.* 5 ribbon');
	act.RunCommands('display Res(Sphere(a_*.m  a_'+code+'prot*.* 5)) xstick');
	act.RunCommands('color a_'+code+'prot*./*/c* grey');
	
	prot_pks.push(my_pk)
	     }
	   });// name="'+code+'prot"');
	
	}
	}
	
	
	
	
	function click_mol_handler(event, my_pk, code){
	
	var ctrl_key = false;
	
	if (event.metaKey || event.ctrlKey){
	
	ctrl_key = true;
	}
	
	var my_div = "MOL"+my_pk
	
	if(event.shiftKey == undefined)
	{
	click_mol(my_pk, code, "M");
	$container.isotope('updateSortData'); $container.isotope({sortBy: 'selected', sortAscending: false});
	return
	}
	
	if (ctrl_key == false && event.shiftKey == false && event.altKey == false){ 
	// Click the molecule
	click_mol(my_pk, code, "M");
	
	
	}
	
	
	if (ctrl_key == true && event.shiftKey ==true && event.altKey == true){ 
	// Update to stop double click
	act.RunCommands("findSymNeighbors  a_"+code+"*. 7. no 2 no yes")
	
	}
	
	if (ctrl_key == false && event.shiftKey == true && event.altKey == false){ 
	
	
	////click_waters(my_pk, code, mol_pk, "W")
	var water_string = mybase+'/Viewer/loader/?choice='+code+'&function=VIEWWATER';
	
	if (document.getElementById(my_div+"BL").className.indexOf("waterClass") > -1){
	document.getElementById(my_div+"BL").className = document.getElementById(my_div+"BL").className.replace(/(?:^|\s)waterClass(?!\S)/g ,'')
	act.RunCommands('delete a_'+code+'water*.*');
	}
	else{
	document.getElementById(my_div+"BL").className += " waterClass";
	//act.RunCommands('read mol "'++'" name="'+c"');
	act.OpenProject(water_string,{
	     name:   code+'water',
	     onload: function () {
	act.RunCommands('display a_'+code+'water*.* xstick');
	     }
	   }
	   );
	}
	}
	
	
	if (ctrl_key == true && event.shiftKey == false && event.altKey == false) { 
	click_prot(event, my_pk, code, "prot")
	}
	
	
	if (ctrl_key == true && event.altKey == true && event.shiftKey == false) { 
	//click_mol_ph4(my_pk, code, mol_pk, "4")
	if (document.getElementById(my_div+"BL").className.indexOf("surfClass") > -1){
	document.getElementById(my_div+"BL").className = document.getElementById(my_div+"BL").className.replace(/(?:^|\s)surfClass(?!\S)/g ,'')
	act.RunCommands('undisplay a_'+code+'prot*.* skin');
	}
	else{
	document.getElementById(my_div+"BL").className += " surfClass";
	
	act.RunCommands('display a_'+code+'prot*.* skin');
	}
	
	}
	
	if (ctrl_key == true && event.shiftKey == true && event.altKey == false) {
	
	if (document.getElementById(my_div+"BL").className.indexOf("ph4Class") > -1){
	document.getElementById(my_div+"BL").className = document.getElementById(my_div+"BL").className.replace(/(?:^|\s)ph4Class(?!\S)/g ,'')
	
	act.RunCommands('delete a_'+code+'pharma.');
	act.RunCommands('display a_'+code+'mol. xstick');
	
	}
	
	else{
	document.getElementById(my_div+"BL").className += " ph4Class";
	var url_string_new =mybase+'/WONKA/ScoreMol/?target={{  target.pk }}&code='+code+'&opt=out'
	act.RunCommands('read pdb "'+url_string_new+'" name="'+code+'pharma"');
	act.RunCommands('display a_'+code+'pharma. xstick');
	act.RunCommands('display a_'+code+'mol. xstick');
	act.RunCommands('color Atom(a_'+code+'pharma.) Bfactor(Atom(a_'+code+'pharma.))');
	}
	
	}
	
	if (ctrl_key == true && event.shiftKey == true && event.altKey == false) { 
	
	        var link = mybase+"{% url 'WONKA:get_grob' target.id %}";
	        link=link.replace('/{{target.id}}/', '/'+my_pk+'/');
	        var my_s = "read grob '"+link+"' name=";
	 act.OpenProject(link,{
	     name:   'my_g',
	     onload: function () {
	        act.RunCommands("display my_g")
	             }
	   }
	   );
	        
	
	}
	
	}
	
	
	
	
	
	
	var tot_data = {{ tot_list|safe }};
	
	//var ph4_pks = {{ ph4_pks|safe }};
	
	//var frag_pks = {{ frag_pks|safe }};
	 
	var out_res_d = {{  out_res_d|safe }}; 
	function generateSetStringCommand(varName, value, file_name) {
	    var varLen = value.length;
	    var blockSize = 3000;
	    var setCode = "";
	    if(varLen < blockSize) {
	    var my_s = varName + " = '" + value + "'";
	    act.RunCommands(varName + " = '" + value + "'");
	    act.RunCommands('write string '+varName+" '"+file_name+"'");
	    }
	    else {
	        var done = blockSize;
	        // Change these to JQUERY - AND MAKE ARRAY / RUNCOMMAND HERE
	        act.RunCommands(varName + " = ''");
	        setCode = varName + " = " + varName + " + '" + value.substring(0, done+blockSize) + "'";
	        act.RunCommands(setCode);
	        while(done < varLen) {
	            // APPEND ARRAY HERE / RUNCOMMAND HERE
	            setCode = varName + " = " + varName + " + '" + value.substring(done, done+blockSize) + "'";
	            act.RunCommands(setCode);
	            done = done + blockSize;
	        }
	        act.RunCommands("db_q = '"+'"'+"'");
	       act.RunCommands('sing_q = "'+"'"+'"');
	       act.RunCommands('my_file = Replace(my_file "<DOUBLE>" db_q)');
	       act.RunCommands('my_file = Replace(my_file "<SINGLE>" sing_q)');
	       act.RunCommands('my_file = Replace(my_file "</PA>" ")")');
	       act.RunCommands('my_file = Replace(my_file "<PA>" "(")');
	       var my_s = 'my_file = Replace(my_file "<NEWLINE>" "\\n")';
	       act.RunCommands(my_s);
	       var my_s = 'write string '+varName+" '"+file_name+"'";
	       act.RunCommands(my_s);
	        return 1;
	    }
	}
	
	var spin_opts = {
	  lines: 13, // The number of lines to draw
	  length: 20, // The length of each line
	  width: 10, // The line thickness
	  radius: 30, // The radius of the inner circle
	  corners: 1, // Corner roundness (0..1)
	  rotate: 0, // The rotation offset
	  direction: 1, // 1: clockwise, -1: counterclockwise
	  color: '#000', // #rgb or #rrggbb or array of colors
	  speed: 1, // Rounds per second
	  trail: 60, // Afterglow percentage
	  shadow: false, // Whether to render a shadow
	  hwaccel: false, // Whether to use hardware acceleration
	  className: 'spinner', // The CSS class to assign to the spinner
	  zIndex: 2e9, // The z-index (defaults to 2000000000)
	  top: '50%', // Top position relative to parent
	  left: '50%' // Left position relative to parent
	};
	
	
	function b64toBlob(b64Data, contentType, sliceSize) {
	    contentType = contentType || '';
	    sliceSize = sliceSize || 512;
	
	    var byteCharacters = atob(b64Data);
	    var byteArrays = [];
	
	    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
	        var slice = byteCharacters.slice(offset, offset + sliceSize);
	
	        var byteNumbers = new Array(slice.length);
	        for (var i = 0; i < slice.length; i++) {
	            byteNumbers[i] = slice.charCodeAt(i);
	        }
	
	        var byteArray = new Uint8Array(byteNumbers);
	
	        byteArrays.push(byteArray);
	    }
	
	    var blob = new Blob(byteArrays, {type: contentType});
	    return blob;
	}
	
	
	function download_blob(shell_var, save_as){
	
	blob = b64toBlob(shell_var, "application/octet-binary", 512)
	saveAs(blob ,save_as)
	
	}
	
	function download_state(){
	
	// Now save this to the file system
	
	// Now save the ICB to the database - to the same object
	var file_name ="ME";
	act.RunCommands("write binary all preview s_tempDir+'/temp.icb'");
	
	act.RunCommands("read blob s_tempDir+'/temp.icb' name='BLOB'");
	
	my_val = act.RunCommandsValue("String(BLOB 'base64')");
	
	
	download_blob(my_val, 'me.icb');
	
	act.RunCommands("delete BLOB");
	
	}
	function download_pdb(){
	
	// Now save this to the file system
	
	// Now save the ICB to the database - to the same object
	var file_name ="ME";
	act.RunCommands("write pdb a_.* s_tempDir+'/temp.pdb'");
	act.RunCommands("read string s_tempDir+'/temp.pdb' name='BLOB'");
	
	var my_var = act.RunCommands("BLOB");
	blob = new Blob([my_var ], {type: "text/text"});
	saveAs(blob ,"me.pdb")
	act.RunCommands("delete BLOB");
	
	}
	
	function save_state(){
	var body = document.getElementsByTagName("body");
	var bodycontent = body[0];
	// Now save this to the database - currently with a random name
	
	// Now save the ICB to the database - to the same object
	var file_name ="ME";
	act.RunCommands("write binary all preview s_tempDir+'/temp.icb'");
	act.RunCommands("read blob s_tempDir+'/temp.icb' name='BLOB'");
	
	var my_j = {}; //$.parseJSON(my_var);
	// Save the image
	act.RunCommands("write image png s_tempDir+'/temp.png'");
	act.RunCommands("read blob s_tempDir+'/temp.png' name='BLOBIM'");
	// Get the image and the binary
	my_j["out_blob_im"] = act.RunCommandsValue("String(BLOBIM 'base64')");
	my_j["out_blob"] = act.RunCommandsValue("String(BLOB 'base64')");
	// Delete them
	act.RunCommands("delete BLOB");
	act.RunCommands("delete BLOBIM");
	
	
	// Pull the image out
	my_j["my_html"] = bodycontent.innerHTML;
	my_j["csrfmiddlewaretoken"] = "{{ csrf_token }}"
	my_j["user"] = {{ user.pk }}
	my_j["comments"] = document.getElementById('inputComments').value
	my_j["target"] = {{ target.pk }}
	
	// Now set the information as to what was in the display
	my_j["prots"] = prot_pks.toString();
	my_j["mols"]  = mol_pks.toString();
	my_j["waters"]  = water_pks.toString();
	my_j["ph4s"]  = seleph4_pks.toString();
	
	
	var URL = "{% url 'WONKA:register_observation' %}";
	var spinner = new Spinner(spin_opts).spin(document.getElementById("LOGIN"));
	    $.post(URL, my_j, function(response){
	        if(response == 'FAIL!'){ 
	        alert('Error! :(');
	        }
	        
	        else{ 
			// Put in the target id as a a blank
	        var link = "{% url 'WONKA:ShowObs' target.id %}";
	        // The nreplace with response
	        link=mybase+link.replace('/{{target.id}}/', '/'+response+'/');
	        document.getElementById("out_link").innerHTML = "<h4>This is the link: <a target='_blank' href='" + link + "'>Click me to see your observation</a></h4>"
	        }
	        spinner.stop();
	    });
	}
	
	
	
	function register(){
	  
	var my_j = {}
	my_j["FirstName"] = document.getElementById('inputFirstName').value
	my_j["LastName"] = document.getElementById('inputLastName').value
	my_j["EMail"] = document.getElementById('inputEMail').value
	my_j["csrfmiddlewaretoken"] = "{{ csrf_token }}"
	if(document.getElementById('inputPassword').value==document.getElementById('inputConfPassword').value){
	
	my_j["Password"] = document.getElementById('inputPassword').value
	}
	else{
	alert("Passwords don't match!");
	return
	}
	
	
	var URL = "{% url 'WONKA:register_user' %}";
	var spinner = new Spinner(spin_opts).spin(document.getElementById("LOGIN"));
	    $.post(URL, my_j, function(response){
	alert(response);
	spinner.stop();
			location.reload();
	
	 });
	  
	  }
	  
	function login(){
	  
	var my_j = {}
	my_j["EMail"] = document.getElementById('inputEMailLOG').value
	my_j["csrfmiddlewaretoken"] = "{{ csrf_token }}"
	my_j["Password"] = document.getElementById('inputPasswordLOG').value
	
	
	
	var URL = "{% url 'WONKA:login_user' %}";
	var spinner = new Spinner(spin_opts).spin(document.getElementById("LOGIN"));
	    $.post(URL, my_j, function(response){
	alert(response);
	spinner.stop();
			location.reload();
	
	 });
	  
	  }
	  
	  
	function show_interactions(mol_pk){
	//Function to show the interactions between a molecule and a protein
	act.RunCommands("delete a_url*.")
	
	//Load the interactions involving this molecule
	url_string = "{% url 'WONKA:get_interactions' %}?obs_id="+mol_pk+"&dist=7.5";
	
	$.ajax({
	  url: url_string,
	  beforeSend: function( xhr ) {
	    xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
	  }
	}).done(function(data){
	  
	    my_j = $.parseJSON(data);
	   	for (var i = 0; i < my_j.length; i++) { 
		// Load them
		act.OpenProject(my_j[i]["url_1"], {});
		act.RunCommands("display a_ xstick red");
		act.RunCommands("me = a_");
		act.OpenProject(my_j[i]["url_2"], {});
		act.RunCommands("display a_ xstick blue");
		act.RunCommands("you = a_");
	
	;	// Show them
		act.RunCommands("make distance me you");
		if (i==0){
		act.RunCommands("display distpairs");
		}
		else{
		act.RunCommands("display distpairs_"+i.toString());
		}
		
		}
		
		
		})
		
	
	};
	
	
	function get_mol_extra(mol_pk){
	// Function to show all the extra PH4 points a molecule could have
	url_string = "{% url 'WONKA:get_pot_ph4s' %}?mol_pk="+mol_pk.toString()+"&lam=2"
	$.ajax({
	  url: url_string,
	  beforeSend: function( xhr ) {
	    xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
	  }
	}).done(function(data){
	
		var my_j = $.parseJSON(data);
		var my_l = my_j["my_pks"]
		for (var i = 0; i < my_l.length; i++) { 
			var my_s = "#choice"+my_l[i].toString()+"ph4all";
			$(my_s).click();
		};
	
	})
	};
	
	
	function find_oommppaa_ph4s(){
	
	for (var i = 0; i <ph4_pks.length; i++) { 
	
	find_oommppaa(ph4_pks[i].toString())
	
	}
	}
	
	function find_oommppaa_frags(){
	
	
	for (var i = 0; i <frag_pks.length; i++) { 
	
	find_oommppaa(frag_pks[i].toString())
	
	}
	
	
	
	};
	
	
	function find_oommppaa(mol_pk){
	
	url_string = "{% url 'WONKA:get_oommppaa_infos' 2 %}"
	url_string = url_string.replace("/2/", "/"+mol_pk+"/")
	my_div = "#OO"+mol_pk;
	$.ajax({
	  url: url_string,
	  beforeSend: function( xhr ) {
	    xhr.overrideMimeType( "text/plain; charset=x-user-defined" );
	  }
	}).done(function(data){
	
		my_j = $.parseJSON(data);
	
		my_div = "#OO"+my_j["pk"].toString();
	
		if(my_j["outcome"] == "error"){
		$(my_div).html('<a class="btn btn-xs btn-info" onclick="alert('+"'"+'Work in progress'+"'"+')"> Go to LLOOMMPPAA </a>' )
	
		}
		else{
	
		
		out_html = '';
		
		mean = my_j["mean"];
		max = my_j["max"];
		min = my_j["min"];
		num = my_j["num"];
		out_html += '<div class="btn-group btn-group-justified btn-group-fill-height">'
		colors = my_j["colors"];
		vals = my_j["vals"];
		for (var i = 0; i <colors.length; i++) { 
			bt_color = colors[i];
			bt_val = vals[i];		
			out_html += '<a class="btn btn-xs" style="border-color: #484857; height:27px; background:'+bt_color+'"></a>' 
		};	
		out_html += '</div>'
		stdev = my_j["stdev"];
		$(my_div).html(out_html)
		}
	
	})
	};
	
	
	function set_data_dp(){
	// Now lets use this to get the button element and then to use that to set the values
	
	// first check what is checked
	my_eles = document.getElementsByClassName("sitecb")
	
	for(i=0; i<my_eles.length; i++){
		my_ele = my_eles[i];
		my_pk = my_ele.id.split("_")[1]
		if(my_ele.checked==false){
		out_s = '.SITE'+my_pk
		$(out_s).hide();
		}
	 }
	
	for(i=0; i<my_eles.length; i++){
		my_ele = my_eles[i];
		my_pk = my_ele.id.split("_")[1]
		if(my_ele.checked==true){
		out_s = '.SITE'+my_pk
		$(out_s).show();
		}
	 }
	
	
	};
	
	
	function show_mols_res_clus(clus_name, clus_col){
	undisplay_all('MOL');
	
	my_eles = document.getElementsByClassName(clus_name)
	for(i=0; i<my_eles.length; i++){
		// Get the molecules PK
		my_pk = parseInt(my_eles[i].id.split("_")[1]);
		// Now display this moelecule
		$('#MOL'+my_pk).click()
		act.RunCommands('display a_'+my_pk+'mol.  xstick');
		act.RunCommands('display a_'+my_pk+'mol.//c*  '+  clus_col +' xstick');
		}
	
	
	
	
	}
	out_url = "";
	// Function to show all observations matching all or some of the info on screen -> e.g. 
	function show_matches(){
	// Get all the features and post them with the url
	
	
	var my_url = "{% url 'WONKA:FindObservations' %}?mol_id="+mol_pks.toString()+"&prot_id="+prot_pks.toString()+"&target_id={{target.pk}}&ph4_id="+seleph4_pks.toString()+"&water_id="+water_pks.toString()
	//alert(my_url);
	out_url = my_url;
	window.open(my_url, target="_blank");
	
	
	}
	
	
	function makeBoxJS(){
	var my_var = act.RunCommandsValue('as_graph').replace(/ /g,'');
	// If it
	var n = my_var.length;
	
	if(n!=0)
	{
	act.RunCommands('display box Box(as_graph)');
	}
	else{
	alert("Nothing selected to make box. Please right-click drag to select atoms");
	//
	};
	};
	
	</script>
	  
	
	  
	  
	    <div class="navbar navbar-default navbar-fixed-top">
	      <div class="container-fluid">
	        <div class="navbar-header">
	          <a href="{% url 'WONKA:index'%}" class="navbar-brand">WONKA</a>
	          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	            <span class="icon-bar"></span>
	          </button>
	        </div>
	        <div class="navbar-collapse collapse" id="navbar-main">
	          <ul class="nav navbar-nav">
	            <li class="dropdown">
	              <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="targets">Targets <span class="caret"></span></a>
	              <ul class="dropdown-menu" aria-labelledby="themes">
				    {% if targets %}
				      {% for Target in targets %}
				        <li><a tabindex="-1"href="{% url 'WONKA:Summarise' Target.id %}">{{ Target.title }}</a></li>
				      {% endfor %}
				    {% else %}
				    <li><a tabindex="-1" >No targets are available.Make your first?</a></li>
				    {% endif %}
	              </ul>
	            </li>
	            <li>
	              <a href="http://www.blopig.com/blog/">Blog</a>
	            </li>
	            <li class="dropdown">
	              <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="download">Download<span class="caret"></span></a>
	                <ul class="dropdown-menu" aria-labelledby="themes">
				       <li><a tabindex="-1"href="https://bitbucket.org/abradley/wonka/wiki/Home">Bitbucket</a></li>
				    </ul>
	            </li>
	          </ul>
	          <ul class="nav navbar-nav">
	            <li>
	              <a href="{% url 'index' %}">HOME</a>
	            </li>
	          </ul>
	          <ul class="nav navbar-nav navbar-left">
	            <li><a>{{ target.title }}</a></li>
	          </ul>
	          <ul class="nav navbar-nav navbar-left">
	            <li><a>{{method }}</a></li>
	          </ul>          
	          <ul class="nav navbar-nav navbar-right">
	            <li><a href="http://builtwithbootstrap.com/" target="_blank">Built With Bootstrap</a></li>
	          </ul>
	        </div>
	      </div>
	    </div>
	<div id="tot-container" class="container-fluid">
	   <div class="row">
		<div id="first-div" style="height:800px;"class="col-lg-3 well-sm">
		<h1>{{target.title}}</h1>  
	    <div style="height:70px">
	       <div class="btn-group" data-toggle="buttons">
	                 <!--
	          <label class="btn btn-primary">
	            <input type="checkbox" name="options" id="key-ph4-button" onchange="show_one('key-ph4','viewer-one','ph4-shows','key_ph4')" > Key PH4
	          </label>
	                    //-->
	          <label class="btn btn-primary">
	            <input type="radio" name="options" id="all-ph4-button" onchange="show_one('all-ph4','viewer-one','all-ph4')">Ligands
	          </label>  
	          <!--
	          <label class="btn btn-primary">
	            <input type="radio" name="options" id="wie-feat-button" onchange="show_one('wie-feat','viewer-one','wie-show','wie_feat')" >Rare PH4
	          </label>
	          <label class="btn btn-danger">
	            <input type="radio" name="options" id="key-frag-button" onchange="show_one('key-frag','viewer-one','frag-show','key_frag')">Key Motif
	          </label>
	          <label class="btn btn-danger">
	            <input type="radio" name="options" id="key-ring-button" onchange="show_one('key-ring','viewer-one','ring-show','key_rings')">Key Ring
	          </label>
	          //-->
	          <label class="btn btn-success">
	            <input type="radio" name="options" id="key-res-button" onchange="show_one('max-res','viewer-one','res-shows','max_shift')">Residues
	          </label>
	          <label class="btn btn-info">
	            <input type="radio" name="options" id="key-water-button" onchange="show_one('key-water','viewer-one','water-shows','key_waters')">Waters
	          </label>
	          <!--
	          <label class="btn btn-success">
	            <input type="radio" name="options" id="coll-water-button" onchange="show_one('coll-water','viewer-one','coll-show','coll_waters')"> Wob H20
	          </label>
	           //-->
			<label class="btn btn-warning">	
	         <input type="radio" name="options" id="key-sites-button" onchange="show_one('mol-clusts','viewer-one','clust-shows','mol_clusts')">Sites
	          </label>                <!--   
	          <label class="btn btn-danger">
	            <input type="checkbox" name="options" id="key-site-button" onchange="show_one('oo-ph4','viewer-one','oo-ph4')">OOMMPPAA
	          </label> 
	          
	          <label class="btn btn-warning">
	            <input type="checkbox" name="options" id="key-site-button" onchange="show_one('oo-frag','viewer-one','oo-frag')">OO Frags
	          </label> 
	                     //-->
	        </div>
	        
	
	                
	        
	        
		</div>
		<div style="overflow-x:scroll;height:300px">
	
		<div class="viewer-one"  style="display:none" id="key-frag-div">
		<h3>Key Motifs</h3>
		<p> <b>left click:</b> toggle display</p>
		{% for mol in key_frag %}
		<div class="row"  style="margin-top:5px;">
		    <div class="col-lg-5" style="border-width:medium; border-color:{{ mol.bg }}">
					  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 160px;color:white;background-color:{{ mol.bg }}">{{mol.myname}} :  {{ mol.num }} %
		                <input  style="display:none" type="checkbox" class="frag-show top-show" id="choice{{mol.pk}}key_frag1"; value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}key_frag1','{{ mol.button }}')">
		                </label>
		              </div>
		    </div>  
		    <div class="col-lg-7 ">  
		            <div class="btn-group btn-group-justified btn-group-fill-height">
		      	{% for item in tot_mols %}
					{% if item.pk in mol.my_list %}
		         		<a class="btn btn-xs btn-success MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% else %}
					    <a class="btn btn-xs btn-default MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% endif %}
				{% endfor %}    
					</div>
		    </div>
		                        
		</div>
		{% endfor %}
		</div>
	 
	
	
		
		<div class="viewer-one"  style="display:none" id="mol-clusts-div">
		
		<h3>Sites</h3>
		
		<p> <b>left click:</b> toggle display</p>
		{% for mol in mol_clusts %}
		<div class="row"  style="margin-top:5px;">
		    <div class="col-lg-5" style="border-width:medium; border-color:{{ mol.bg }}">
					  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 40px;color:white;background-color:{{ mol.bg }}">{{mol.size}}
		                <input  style="display:none" type="checkbox" class="clust-show top-show" id="choice{{mol.pk}}key_site"; value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}key_site','{{ mol.button }}')">
		                </label>
		              </div>
					  <a  class="btn btn-xs btn-success" onclick="loadsite('{{target.pk}}','{{mol.pk}}')" target="_blank"> ANALYSE</a>
					{% if forloop.counter0 == 0 %}
					  <input type="checkbox" class="sitecb" name="options" id="site_{{mol.pk}}" onchange="set_data_dp()" checked></input>
					 {% else %}
					 <input type="checkbox" class="sitecb" name="options" id="site_{{mol.pk}}" onchange="set_data_dp()"></input>
					 {% endif %}
					 
		    </div>  
		    <div class="col-lg-7 ">  
		            <div class="btn-group btn-group-justified btn-group-fill-height">
		      	{% for item in tot_mols %}
					{% if item.pk in mol.my_list %}
		         		<a class="btn btn-xs btn-success MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% else %}
					    <a class="btn btn-xs btn-default MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% endif %}
				{% endfor %}    
					</div>
				
		    </div>        
		</div>
		{% endfor %}
		</div>
	 
	 
	 
	<div class="viewer-one"  style="display:none" id="key-ring-div">
		<h3>Key Rings</h3>
		<p> <b>left click:</b> toggle display</p>
		{% for mol in key_rings %}
		<div class="row"  style="margin-top:5px;">
		    <div class="col-lg-5"  style="border-width:medium; border-color:{{ mol.bg }}">
		              
				<div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 160px;color:white;background-color:{{ mol.bg }}">{{mol.myname}} :  {{ mol.size }}
		                <input  style="display:none" type="checkbox" class="ring-show top-show" id="choice{{mol.pk}}key_ring1"; value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}key_ring1','{{ mol.button }}')">
		                </label>
		         </div>
		    </div>
		    <div class="col-lg-7 ">  
		       <div class="btn-group btn-group-justified btn-group-fill-height">
		       	{% for item in tot_mols %}
					{% if item.pk in mol.my_list %}
		         		<a class="btn btn-xs btn-success MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% else %}
					    <a class="btn btn-xs btn-default MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% endif %}
				{% endfor %}    
		        </div>     
		     </div>         
		</div>
		{% endfor %}
	</div>
	
	
	
	
	              
	<div class="viewer-one"  style="display:none" id="key-water-div">
		<h3>Key Waters</h3>
		<p> <b>left click:</b> toggle display</p>
		<div  class="row">
		<p class="col-lg-6"></p>
	
		<img src="{% static "WONKA/key.png" %}"></img>
		</div>
		{% for mol in key_waters %}
		<div  class="row {{mol.sites}}" style="margin-top:5px;">
		    <div class="col-lg-5" style="border-width:medium; border-color:{{ mol.bg }}">
					  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 100px;color:white;background-color:blue;"> Water: {{ mol.per_size }}% 
		                <input  style="display:none" type="checkbox" class="water-show top-show" id="choice{{mol.pk}}key_water"; value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}key_water','{{ mol.button }}','{{mol.rel_size}}', 'water')">
		                </label>
		              </div>
		    </div>
		    <div class="col-lg-7 ">
		            <div class="btn-group btn-group-justified btn-group-fill-height">
		      	{% for item in tot_mols %}
					{% if item.pk in mol.my_list %}
		         		<a class="btn btn-xs btn-default MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% else %}
					    <a class="btn btn-xs btn-success MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% endif %}
				{% endfor %}                      
				    </div>
		 	</div>
		 </div>
		{% endfor %}
	</div>
	              
	 <div class="viewer-one"  style="display:none" id="coll-water-div">
		<h3>Wobbly Waters</h3>
		<p> <b>left click:</b> toggle display</p>
		<div  class="row">
		<p class="col-lg-6"></p>
	
		<img src="{% static "WONKA/key.png" %}"></img>
		</div>
		{% for mol in coll_waters %}
		<div  class="row" style="margin-top:5px;">
		    <div class="col-lg-5" style="border-width:medium; border-color:{{ mol.bg }}">
					  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 160px;color:white;background-color:{{ mol.bg }}"> Conserved water ({{ mol.size }}) 
		                <input  style="display:none" type="checkbox" class="coll-show top-show" id="choice{{mol.pk}}coll_water"; value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}coll_water','{{ mol.button }}')">
		                </label>
		              </div>
		    </div>
		    <div class="col-lg-7 ">
		            <div class="btn-group btn-group-justified btn-group-fill-height">
		      	{% for item in tot_mols %}
					{% if item.pk in mol.my_list %}
		         		<a class="btn btn-xs btn-default MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% else %}
					    <a class="btn btn-xs btn-success MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% endif %}
				{% endfor %}                      
				    </div>
		 	</div>
		 </div>
		{% endfor %}
	</div>
	 
	 
	<div class="viewer-one" style="display:none" id="key-ph4-div">
	
		<h3>Key Pharmacophores</h3>
		<p> <b>left click:</b> toggle display</p>
		<div  class="row">
		<p class="col-lg-6"></p>
	
		<img src="{% static "WONKA/key.png" %}"></img>
		</div>
		{% for mol in key_ph4 %}
		<div class="row"  style="margin-top:5px;">
		    <div class="col-lg-5"  style="border-width:medium; border-color:{{ mol.bg }}">
					  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 160px;color:white;background-color:{{ mol.bg }}">{{ mol.smiles }} :  {{ mol.num }} %
		                <input  style="display:none" type="checkbox" class="ph4-show top-show" id="choice{{mol.pk}}ph4"; value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}ph4','{{ mol.button }}')">
		                </label>
		              </div>
		     </div>
		     <div class="col-lg-7 ">
		          <div class="btn-group btn-group-justified btn-group-fill-height">
		      	{% for item in tot_mols %}
					{% if item.pk in mol.my_list %}
					    {% if tot_mols|length > 20 %}
		         		    <a class="btn btn-xs btn-success MOL{{item.pk}} btn-off" style="display:compact" onclick="$('#MOL{{item.pk}}').click()"></a>
						{% else %}
						  	<a class="btn btn-xs btn-success MOL{{item.pk}} btn-off" style="height:27px" onclick="$('#MOL{{item.pk}}').click()"></a>
						{% endif %}
					{% else %}
					    <a class="btn btn-xs btn-default MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% endif %}			
				{% endfor %}    
		             </div>       
		     </div>         
	    </div>
		{% endfor %}
	</div>
	
	<div class="viewer-one" style="display:none" id="all-ph4-div">
		<h3>All Pharmacophores</h3>
		<p> <b>left click:</b> toggle display</p>
		<div  class="row">
		<p class="col-lg-6"></p>
	
		<img src="{% static "WONKA/key.png" %}"></img>
		</div>
		{% for mol in all_ph4s %}
		<div class="row {{mol.sites}}"  style="margin-top:5px;">
		    <div class="col-lg-5"  style="border-width:medium; border-color:{{ mol.bg }}">
					  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 135px;color:white;background-color:{{ mol.bg }}">{{ mol.smiles }}: {{ mol.per_size }} %
		                <input  style="display:none" type="checkbox" class="top-show" id="choice{{mol.pk}}ph4all"; value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}ph4all','{{ mol.button }}','{{mol.rel_size}}','ph4')">
		                </label>
		              </div>              
		     </div>
		     <div class="col-lg-7 ">
		          <div class="btn-group btn-group-justified btn-group-fill-height">
		      	{% for item in tot_mols %}
					{% if item.pk in mol.my_list %}
		         		<a class="btn btn-xs btn-success my-btn-has MOL{{item.pk}} btn-off" style="height:27px" onclick="$('#MOL{{item.pk}}').click()"></a>
					{% else %}
					    <a class="btn btn-xs btn-default my-btn-not MOL{{item.pk}} btn-off" style="height:27px"  onclick="$('#MOL{{item.pk}}').click()"></a>
					{% endif %}
				{% endfor %}    
		             </div>       
		     </div>         
	    </div>
		{% endfor %}
	</div>
	
	
	<div class="viewer-one" style="display:none" id="oo-ph4-div">
		<h3>OOMMPPAA Pharmacophores</h3>
		<p> <b>left click:</b> toggle display</p>
	    <a onclick='find_oommppaa_ph4s()' class="btn btn-sm btn-success">Do OOOMMPPAAA</a>
		<div  class="row">
		<p class="col-lg-6"></p>
	
		</div>
		{% for mol in all_ph4s %}
		<div class="row"  style="margin-top:5px;">
		    <div class="col-lg-5"  style="border-width:medium; border-color:{{ mol.bg }}">
					  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 140px;color:white;background-color:{{ mol.bg }}">{{ mol.smiles }}
		                <input  id='choice{{mol.pk}}ph4oo'  style="display:none" type="checkbox" class="top-show" value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}ph4oo','{{ mol.button }}','{{mol.rel_size}}','ph4')">
		                </label>
		              </div>              
		     </div>
		     <div id="OO{{mol.pk}}" class="col-lg-7 ">
		     </div>       
	    </div>
		{% endfor %}
	</div>
	
	<div class="viewer-one" style="display:none" id="oo-frag-div">
		<h3>OOMMPPAA Fragments</h3>
		<p> <b>left click:</b> toggle display</p>
		<a onclick='find_oommppaa_frags()' class="btn btn-sm btn-success">Do OOOMMPPAAA</a>
		<div  class="row">
		<p class="col-lg-6"></p>
		</div>
		{% for mol in all_frags %}
		<div class="row"  style="margin-top:5px;">
		    <div class="col-lg-5"  style="border-width:medium; border-color:blue">
					  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px" class="checkbox">
		                <label class="btn-sm" style="width: 140px;color:white;background-color:blue">{{ mol.function }}
		                <input  style="display:none" type="checkbox" class="top-show" value="{{ mol.pk }}" onclick="find_oommppaa('{{ mol.pk }}')">
		                </label>
		              </div>              
		     </div>
		     <div id="OO{{mol.pk}}" class="col-lg-7 ">
		     </div>         
	    </div>
		{% endfor %}
	</div>
	
	
	<div class="viewer-one" style="display:none" id="max-res-div">
	
	<h3>Large residue shifts</h3>
	<p> <b>left click:</b> toggle display</p>
	
	{% for mol in max_shift %}
		<div class="row {{mol.sites}}"  style="margin-top:5px;">
		    <div class="col-sm-4">
		    	  <div style="display:inline-block;margin-top:0px;margin-bottom:0px;" class="checkbox">
	                <label class="btn-sm btn-info" >{{ mol.my_name }}
	                <input  style="display:none;" type="checkbox" class="res-show top-show" id="choice{{ forloop.counter }}res"; value="{{ mol.pk }}" onclick="show_res('{{mol.res}}','choice{{ forloop.counter }}res','{{mol.button}}')">
	                </label>
	              </div>
	
	        </div>
	        <div class="col-sm-2" style="padding-left: 3px;padding-right: 3px;">
	            <div class="btn-group btn-group-justified btn-group-fill-height">
	        {% for clu, val in mol.res_cl.items %}
		       	<a id="{{ clu }}__ON" onclick="show_mols_res_clus('{{ clu }}','{{ val.1 }}')" class="btn btn-xsm" style="background:{{ val.0 }};" ></a>
	       	{% endfor %}
	       		</div>  
	        </div>
	       	<div class="col-sm-2" style="padding-left: 3px;padding-right: 3px;">
	        <a id="{{ mol.res }}__ON" onclick="document.getElementById('{{ mol.res }}__OFF').style.display='';document.getElementById('{{ mol.res }}__ON').style.display='none';centre_res('{{ mol.res }}')" class="btn btn-sm btn-info" >Show</a>
	        <a id="{{ mol.res }}__OFF" style="display:none" onclick="document.getElementById('{{ mol.res }}__ON').style.display='';document.getElementById('{{ mol.res }}__OFF').style.display='none';del_res('{{ mol.res }}')" class="btn btn-sm btn-danger" >Hide</a>
	      	</div>
	      	<div class="col-sm-4" style="padding-left: 3px;padding-right: 3px;">
		          <div class="btn-group btn-group-justified btn-group-fill-height">
		      	{% for item in mol.my_list %}
		         		<a class="{{item.clus_id}} btn btn-xs MOL{{item.pk}} btn-off" id="MYMOL_{{item.pk}}" style="background:{{ item.colour }}; height:27px" onclick="$('#MOL{{item.pk}}').click()"></a>
				{% endfor %}    
		             </div>  
		    </div>  
	</div>
	{% endfor %}
	       </div>
	    
	  
	
	       
	       
	       
	
	  <!--   
	<div class="viewer-one" style="display:none" id="wie-feat-div">
		<h3>Rare Ph4s</h3>
		<p> <b>left click:</b> toggle display</p>
		<div  class="row">
			<p class="col-lg-6"></p>
			<img src="{% static "WONKA/key.png" %}"></img>
		</div>
		{% for mol in wie_feat %}
	    <div class="row"  style="margin-top:5px;">
	    	<div class="col-lg-5"  style="border-width:medium; border-color:{{ mol.bg }}">              
				  <div  style="display:inline-block;margin-top:0px;margin-bottom:0px;" class="checkbox">
	                <label class="btn-sm" style="width: 160px;color:white;background-color:{{ mol.bg }}">{{ mol.smiles }}
	                <input  style="display:none" type="checkbox" class="wie-show top-show" id="choice{{mol.pk}}wie_feat1"; value="{{ mol.pk }}" onclick="show_mol_prot('{{mol.url_centre}}','choice{{mol.pk}}wie_feat1','{{ mol.button }}')">
	                </label>
	              </div>
	         </div>
		     <div class="col-lg-7 ">
		          <div class="btn-group btn-group-justified btn-group-fill-height">
		      	{% for item in tot_mols %}
					{% if item.pk in mol.my_list %}
		         		<a class="btn btn-xs btn-success MOL{{item.pk}} btn-off" style="height:27px" onclick="$('#MOL{{item.pk}}').click()"></a>
					{% else %}
					    <a class="btn btn-xs btn-default MOL{{item.pk}} btn-off" style="height:27px" onclick="$('#MOL{{item.pk}}').click()"></a>
					{% endif %}
				{% endfor %}    
		             </div>       
		     </div>  
	     </div>
		{% endfor %}
	</div>
	       
	       
	 /-->
	       
		
	</div>	 
		
		<div id="mol-container">
	         <h3>Molecules:</h3> 
	         <p> <b>left-click:</b> show moleclule ||<b>  ctrl+left-click:</b> show protein </p>
	         <p> <b>shift+left-click:</b> show water || <b>  ctrl+alt+left-click:</b> toggle surface</p>
	         <a id="unds_all_but" onclick="undisplay_all('MOL');" class="btn btn-sm btn-success">Undisplay Ligs</a>
	         <a id="show_matches_but" onclick="show_matches();" class="btn btn-sm btn-info">Show matches</a>
	          {% if ll_mols %}
	         <a onclick="document.getElementById('lloommppaa-cont').style.display='none';document.getElementById('iso-cont').style.display='';" class="btn btn-sm btn-warning">WONKA</a>
	         <a onclick="document.getElementById('iso-cont').style.display='none';document.getElementById('lloommppaa-cont').style.display='';" class="btn btn-sm btn-danger">LLOOMMPPAA</a>
	         {% endif %}
	 <!--  
	         <a onclick="$container.isotope({sortBy: 'activity', sortAscending: false});" class="btn btn-sm btn-info">Order Activity</a>
	 /-->
	         <a onclick="$container.isotope({sortBy: 'cluster', sortAscending: true});" class="btn btn-sm btn-info">Order Chem</a>
	
			<div style="overflow-y:scroll;height:550px;">
				<div id="iso-cont" >
		     	{% for mol in tot_mols %}
			     	    {% if mol.acts %}
					 	<a data-toggle="tooltip" data-placement="top" title="{{mol.my_id}}: {{ mol.acts|floatformat }}" class="container" style="cursor:pointer"  id="MOL{{mol.pk}}BL">
					 	{% else %}
					   <a data-toggle="tooltip" data-placement="top" title="{{mol.my_id}} " class="container" style="cursor:pointer"  id="MOL{{mol.pk}}BL">
						{% endif %}
					    <img data-pk="{{ mol.pk }}" data-cluster={{ mol.cluster }} data-activity={{ mol.acts }} data-category="{{ mol.category }}" class="img_class" src={{mol.src}}  id="MOL{{mol.pk}}" type="checkbox" value="{{ mol.pk }}" onclick="click_mol_handler(event,'{{mol.pk}}','{{ mol.code}}')"  style="opacity:0.5;border-style:dash;width:100%"></img>
						</a>
				{% endfor %}
		        </div>
	            {% if ll_mols %}
					<div style="display:none" id="lloommppaa-cont" >
			     	{% for mol in ll_mols %}
				     	    {% if mol.acts %}
						 	<a data-toggle="tooltip" data-placement="top" title="{{mol.my_id}}: {{ mol.acts|floatformat }}" class="container" style="cursor:pointer"  id="MOL{{mol.pk}}BL">
						 	{% else %}
						   <a data-toggle="tooltip" data-placement="top" title="{{mol.my_id}} " class="container" style="cursor:pointer"  id="MOL{{mol.pk}}BL">
							{% endif %}
						    <img data-pk="{{ mol.pk }}" data-cluster={{ mol.cluster }} data-activity={{ mol.acts }} data-category="{{ mol.category }}" class="img_class" src={{mol.src}}  id="MOL{{mol.pk}}" type="checkbox" value="{{ mol.pk }}" onclick="click_mol_handler(event,'{{mol.pk}}','{{ mol.code}}')"  style="opacity:0.5;border-style:dash;width:100%"></img>
							</a>
					{% endfor %}
		        </div>
		         {% endif %}
	        </div>
	    </div>	
		</div>
		
		<div id="ICM-box" style="margin-top:20px;" class="col-lg-9">
		  <div id="ICM-container">
	<div id="act_div" style="width: 100%; height: 600px; border: 2px solid #ABABAB">
	</div>	<p></p>
		<a data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Gives ICM a brutal black background" class="btn btn-sm btn-default" onclick="act.RunCommands('color background rgb={0,0,0}');">Dark display</a>
	    <a data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Gives ICM a shiny white background" class="btn btn-sm btn-default" onclick="act.RunCommands('color background rgb={255,255,255}');">White display</a>
		<a data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Show the compounds from the selected points" id="mmpdispbutt" style="margin-left:10px;display:none" onclick="document.getElementById('newmolcanv').style.display='';findasgr('{{ maps.0.pk }},{{ maps.1.pk }},{{ maps.2.pk }}','newmolcanv');" class="btn btn-sm btn-success">Display compounds</a>
	    <a data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Remove those compounds from the 3D display" id="mmprembutt" style="display:none" onclick="act.RunCommands('GRAPHICS.l_redraw = no');act.RunCommands('delete a_MOL*.*');act.RunCommands('GRAPHICS.l_redraw = yes');act.RunCommands('display new');" class="btn btn-sm btn-warning">Remove </a>
	    <a data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Show the highlighted Residue" id="showresbutt" style="" onclick="alert(act.RunCommandsValue('String(Res(as_graph))'))" class="btn btn-sm btn-info">Show Res</a>
	
	<a href="{% url 'WONKA:ShowObservations' target.pk %}"  class="btn btn-sm btn-success">Show Observations</a>
	<a onclick="download_state();" class="btn btn-sm btn-success">Download ICB</a>
	<a onclick="alert(my_txt);" class="btn btn-sm btn-warning">Help with 3D Display</a>
	<p></p>
	{% endif %}
	{% if user.is_authenticated %}
	<h4>Hi {{ user.first_name }} - make a comment</h4>
	
	<div  id="LOGIN" class="col-lg-6" >
		<div id="out_link"></div>
	    <div class="form-group">
	        <label for="inputComments">Comments</label>
	        <input type="Comments" class="form-control" id="inputComments" placeholder="Comments">
	    </div>
	    <a onclick="save_state();" class="btn btn-sm btn-success">Save states</a>
	</div>
	{% else %}
	    <h3>Please log in or register.</h3>
	
	 	 <div  id="LOGIN" class="col-lg-6" >
	    <div class="form-group">
	        <label for="inputFirstName">First Name</label>
	        <input type="First Name" class="form-control" id="inputFirstName" placeholder="First Name">
	    </div>
	    <div class="form-group">
	        <label for="inputLastName">Last Name</label>
	        <input type="Last Name" class="form-control" id="inputLastName" placeholder="Last Name">
	    </div>
	    <div class="form-group">
	        <label for="inputEMail">E-mail</label>
	        <input type="E-Mail" class="form-control" id="inputEMail" placeholder="E-mail">
	    </div>
	    <div class="form-group">
	        <label for="inputPassword">Password</label>
	        <input type="Password" class="form-control" id="inputPassword" placeholder="Password"">
	    </div>
	    <div class="form-group">
	        <label for="inputConfPassword">Confirm Password</label>
	        <input type="Password" class="form-control" id="inputConfPassword" placeholder="Confirm Password"">
	    </div>
	    <a onclick="register();" class="btn btn-sm btn-success">Register</a>
		</div>
		 	 <div class="col-lg-6" >
	
	    <div class="form-group">
	        <label for="inputEMailLOG">E-mail</label>
	        <input type="E-Mail" class="form-control" id="inputEMailLOG" placeholder="E-mail">
	    </div>
	    <div class="form-group">
	        <label for="inputPasswordLOG">Password</label>
	        <input type="Password"" class="form-control" id="inputPasswordLOG" placeholder="Password"">
	    </div>
	    <a onclick="login();" class="btn btn-sm btn-success">Login</a>
		</div>
		{% endif %}
	
	
	
	
	    </div>
	
		</div>
	    
	    
	
	    
	  
	  
	</div>
	
	</body>
	</html> 
